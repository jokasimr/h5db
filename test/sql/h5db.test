# name: test/sql/h5db.test
# description: test h5db extension
# group: [sql]

# Require statement will ensure this test is run with this extension loaded
require h5db

# Test basic extension loading
query I
SELECT h5db('Sam');
----
H5db Sam üê•

query I
SELECT h5db_openssl_version('Michael') ILIKE 'H5db Michael, my linked OpenSSL version is OpenSSL%';
----
true

query I
SELECT h5db_version('test') ILIKE 'H5db test, HDF5 version 1.%';
----
true

# =============================================================================
# h5_tree() Tests
# =============================================================================

# Test h5_tree on simple.h5 - should list all objects
query IIII
SELECT COUNT(*),
       COUNT(*) FILTER (WHERE type = 'group'),
       COUNT(*) FILTER (WHERE type = 'dataset'),
       COUNT(*) FILTER (WHERE dtype = 'int32')
FROM h5_tree('test/data/simple.h5');
----
10	3	7	2

# Test h5_tree shows correct types for specific datasets
query IIII
SELECT
    COUNT(*) FILTER (WHERE path = '/integers' AND dtype = 'int32'),
    COUNT(*) FILTER (WHERE path = '/floats' AND dtype = 'float64'),
    COUNT(*) FILTER (WHERE path = '/strings' AND dtype = 'string'),
    COUNT(*) FILTER (WHERE path = '/matrix' AND dtype = 'int32' AND shape = '(5, 4)')
FROM h5_tree('test/data/simple.h5');
----
1	1	1	1

# Test h5_tree on types.h5 - comprehensive type detection
query III
SELECT
    COUNT(*) FILTER (WHERE dtype LIKE 'int%'),
    COUNT(*) FILTER (WHERE dtype LIKE 'uint%'),
    COUNT(*) FILTER (WHERE dtype LIKE 'float%')
FROM h5_tree('test/data/types.h5');
----
4	3	2

# Test h5_tree shows correct shapes for multi-dimensional arrays
query IIII
SELECT
    COUNT(*) FILTER (WHERE path = '/array_1d' AND shape = '(10)'),
    COUNT(*) FILTER (WHERE path = '/array_2d' AND shape = '(5, 4)'),
    COUNT(*) FILTER (WHERE path = '/array_3d' AND shape = '(5, 4, 3)'),
    COUNT(*) FILTER (WHERE path = '/array_4d' AND shape = '(5, 4, 3, 2)')
FROM h5_tree('test/data/multidim.h5');
----
1	1	1	1

# Test h5_tree error handling - non-existent file
statement error
SELECT * FROM h5_tree('nonexistent.h5');
----
IO Error: Failed to open HDF5 file: nonexistent.h5

# =============================================================================
# h5_read() Tests - 1D Numeric Types
# =============================================================================

# Test reading int32 dataset
query I
SELECT COUNT(*) FROM h5_read('test/data/simple.h5', '/integers');
----
10

query I
SELECT SUM(integers) FROM h5_read('test/data/simple.h5', '/integers');
----
45

# Test reading different integer sizes
query I
SELECT COUNT(*) FROM h5_read('test/data/types.h5', '/int8');
----
3

query I
SELECT SUM(int8) FROM h5_read('test/data/types.h5', '/int8');
----
6

query I
SELECT COUNT(*) FROM h5_read('test/data/types.h5', '/int16');
----
3

query I
SELECT COUNT(*) FROM h5_read('test/data/types.h5', '/int32');
----
2

query I
SELECT SUM(int32) FROM h5_read('test/data/types.h5', '/int32');
----
30000

query I
SELECT COUNT(*) FROM h5_read('test/data/types.h5', '/int64');
----
1

# Test unsigned integers
query I
SELECT COUNT(*) FROM h5_read('test/data/types.h5', '/uint8');
----
2

query I
SELECT MAX(uint8) FROM h5_read('test/data/types.h5', '/uint8');
----
255

query I
SELECT COUNT(*) FROM h5_read('test/data/types.h5', '/uint16');
----
1

query I
SELECT COUNT(*) FROM h5_read('test/data/types.h5', '/uint32');
----
1

# Test float types
query I
SELECT COUNT(*) FROM h5_read('test/data/simple.h5', '/floats');
----
10

query I
SELECT COUNT(*) FROM h5_read('test/data/types.h5', '/float32');
----
2

query I
SELECT COUNT(*) FROM h5_read('test/data/types.h5', '/float64');
----
1

# =============================================================================
# h5_read() Tests - String Types
# =============================================================================

# Test fixed-length strings
query I
SELECT COUNT(*) FROM h5_read('test/data/simple.h5', '/strings');
----
3

query I
SELECT strings FROM h5_read('test/data/simple.h5', '/strings') ORDER BY strings;
----
hello
test
world

# Test variable-length strings
query I
SELECT COUNT(*) FROM h5_read('test/data/types.h5', '/var_strings');
----
3

query I
SELECT var_strings FROM h5_read('test/data/types.h5', '/var_strings') ORDER BY var_strings;
----
length
strings
variable

# Test fixed-length strings from types.h5
query I
SELECT COUNT(*) FROM h5_read('test/data/types.h5', '/fixed_strings');
----
2

query I
SELECT fixed_strings FROM h5_read('test/data/types.h5', '/fixed_strings') ORDER BY fixed_strings;
----
fixed
width

# =============================================================================
# h5_read() Tests - Nested Group Paths
# =============================================================================

# Test reading from nested group
query I
SELECT COUNT(*) FROM h5_read('test/data/simple.h5', '/group1/data1');
----
5

query I
SELECT SUM(data1) FROM h5_read('test/data/simple.h5', '/group1/data1');
----
10.0

query I
SELECT COUNT(*) FROM h5_read('test/data/simple.h5', '/group1/data2');
----
10

query I
SELECT COUNT(*) FROM h5_read('test/data/simple.h5', '/group1/subgroup/nested_data');
----
100

# =============================================================================
# h5_read() Tests - 2D Arrays
# =============================================================================

# Test 2D array reading
query I
SELECT COUNT(*) FROM h5_read('test/data/simple.h5', '/matrix');
----
5

# Test 2D array element access
query I
SELECT matrix[1] FROM h5_read('test/data/simple.h5', '/matrix') LIMIT 1;
----
0

query I
SELECT matrix[2] FROM h5_read('test/data/simple.h5', '/matrix') LIMIT 1;
----
1

# Test 2D array from multidim.h5
query I
SELECT COUNT(*) FROM h5_read('test/data/multidim.h5', '/array_2d');
----
5

query I
SELECT array_2d[1] FROM h5_read('test/data/multidim.h5', '/array_2d') LIMIT 1;
----
0

query I
SELECT array_2d[4] FROM h5_read('test/data/multidim.h5', '/array_2d') LIMIT 1;
----
3

# Test sum of all elements in 2D array
query I
SELECT SUM(elem) FROM (
    SELECT UNNEST(matrix) as elem FROM h5_read('test/data/simple.h5', '/matrix')
);
----
190

# =============================================================================
# h5_read() Tests - 3D Arrays
# =============================================================================

# Test 3D array reading
query I
SELECT COUNT(*) FROM h5_read('test/data/multidim.h5', '/array_3d');
----
5

# Test 3D array access - first dimension
query I
SELECT array_3d[1][1] FROM h5_read('test/data/multidim.h5', '/array_3d') LIMIT 1;
----
0

query I
SELECT array_3d[1][2] FROM h5_read('test/data/multidim.h5', '/array_3d') LIMIT 1;
----
1

query I
SELECT array_3d[2][1] FROM h5_read('test/data/multidim.h5', '/array_3d') LIMIT 1;
----
3

# Test that we get 5 rows with correct structure
query I
SELECT COUNT(*) FROM h5_read('test/data/multidim.h5', '/array_3d') WHERE array_3d IS NOT NULL;
----
5

# =============================================================================
# h5_read() Tests - 4D Arrays
# =============================================================================

# Test 4D array reading
query I
SELECT COUNT(*) FROM h5_read('test/data/multidim.h5', '/array_4d');
----
5

# Test 4D array access
query I
SELECT array_4d[1][1][1] FROM h5_read('test/data/multidim.h5', '/array_4d') LIMIT 1;
----
0

query I
SELECT array_4d[1][1][2] FROM h5_read('test/data/multidim.h5', '/array_4d') LIMIT 1;
----
1

# =============================================================================
# h5_read() Tests - Error Handling
# =============================================================================

# Test error on non-existent file
statement error
SELECT * FROM h5_read('nonexistent.h5', '/dataset');
----
IO Error: Failed to open HDF5 file: nonexistent.h5

# Test error on non-existent dataset
statement error
SELECT * FROM h5_read('test/data/simple.h5', '/nonexistent');
----
IO Error: Failed to open dataset: /nonexistent

# =============================================================================
# h5_read() Tests - Column Naming
# =============================================================================

# Test that column names are derived from dataset name (last part of path)
query I
SELECT column_name FROM (DESCRIBE SELECT * FROM h5_read('test/data/simple.h5', '/integers'));
----
integers

query I
SELECT column_name FROM (DESCRIBE SELECT * FROM h5_read('test/data/simple.h5', '/group1/data1'));
----
data1

query I
SELECT column_name FROM (DESCRIBE SELECT * FROM h5_read('test/data/simple.h5', '/group1/subgroup/nested_data'));
----
nested_data

# =============================================================================
# h5_read() Tests - Type Detection
# =============================================================================

# Test that types are correctly detected
query I
SELECT column_type FROM (DESCRIBE SELECT * FROM h5_read('test/data/simple.h5', '/integers'));
----
INTEGER

query I
SELECT column_type FROM (DESCRIBE SELECT * FROM h5_read('test/data/simple.h5', '/floats'));
----
DOUBLE

query I
SELECT column_type FROM (DESCRIBE SELECT * FROM h5_read('test/data/simple.h5', '/strings'));
----
VARCHAR

query I
SELECT column_type FROM (DESCRIBE SELECT * FROM h5_read('test/data/types.h5', '/int8'));
----
TINYINT

query I
SELECT column_type FROM (DESCRIBE SELECT * FROM h5_read('test/data/types.h5', '/uint8'));
----
UTINYINT

query I
SELECT column_type FROM (DESCRIBE SELECT * FROM h5_read('test/data/types.h5', '/float32'));
----
FLOAT

# Test array types
query I
SELECT column_type FROM (DESCRIBE SELECT * FROM h5_read('test/data/simple.h5', '/matrix'));
----
INTEGER[4]

query I
SELECT column_type FROM (DESCRIBE SELECT * FROM h5_read('test/data/multidim.h5', '/array_3d'));
----
BIGINT[3][4]

query I
SELECT column_type FROM (DESCRIBE SELECT * FROM h5_read('test/data/multidim.h5', '/array_4d'));
----
BIGINT[2][3][4]

# =============================================================================
# Integration Tests - Combining h5_tree() and h5_read()
# =============================================================================

# Use h5_tree to find datasets, then read them
query I
SELECT COUNT(*)
FROM (
    SELECT path FROM h5_tree('test/data/simple.h5') WHERE type = 'dataset' AND dtype = 'int32'
) datasets;
----
2

# Dynamic query: read all 1D int32 datasets
query I
SELECT COUNT(*)
FROM h5_read('test/data/simple.h5', '/integers');
----
10

# =============================================================================
# Performance Tests - Large Dataset Handling
# =============================================================================

# Test reading dataset with 100 elements (nested_data)
query I
SELECT COUNT(*) FROM h5_read('test/data/simple.h5', '/group1/subgroup/nested_data');
----
100

query II
SELECT MIN(nested_data), MAX(nested_data)
FROM h5_read('test/data/simple.h5', '/group1/subgroup/nested_data');
----
0	99

# =============================================================================
# Edge Cases
# =============================================================================

# Test reading 1D array (should work as scalar values)
query I
SELECT COUNT(*) FROM h5_read('test/data/multidim.h5', '/array_1d');
----
10

query I
SELECT SUM(array_1d) FROM h5_read('test/data/multidim.h5', '/array_1d');
----
45

# Test that root group ("/." path) appears in h5_tree
query I
SELECT COUNT(*) FROM h5_tree('test/data/simple.h5') WHERE path = '/.';
----
1

# =============================================================================
# Multi-Dataset Reading Tests
# =============================================================================

# Test reading two 1D datasets
query II
SELECT integers, floats FROM h5_read('test/data/simple.h5', '/integers', '/floats') LIMIT 1;
----
0	0.16153323088505145

# Test reading three datasets with different types
query II
SELECT COUNT(*), SUM(integers) FROM h5_read('test/data/simple.h5', '/integers', '/floats', '/strings');
----
3	3

# Test that minimum row count is used (strings has 3, integers has 10)
query I
SELECT COUNT(*) FROM h5_read('test/data/simple.h5', '/integers', '/strings');
----
3

# Test reading from nested groups
query II
SELECT data1, data2 FROM h5_read('test/data/simple.h5', '/group1/data1', '/group1/data2') LIMIT 1;
----
0.0	1

# Test reading scalar and array datasets together
query I
SELECT matrix[1] FROM h5_read('test/data/simple.h5', '/integers', '/matrix') LIMIT 1;
----
0

# Test reading multiple datasets with different integer types
query II
SELECT int8, int16 FROM h5_read('test/data/types.h5', '/int8', '/int16') LIMIT 1;
----
1	100

# Test reading multiple string datasets
query II
SELECT fixed_strings, var_strings FROM h5_read('test/data/types.h5', '/fixed_strings', '/var_strings') ORDER BY fixed_strings LIMIT 1;
----
fixed	variable

# Test reading multiple multi-dimensional arrays
query I
SELECT COUNT(*) FROM h5_read('test/data/multidim.h5', '/array_2d', '/array_3d');
----
5

# Test column naming with multiple datasets
query I
SELECT column_name FROM (DESCRIBE SELECT * FROM h5_read('test/data/simple.h5', '/integers', '/floats')) ORDER BY column_name;
----
floats
integers

# Test type detection with multiple datasets
query I
SELECT column_type FROM (DESCRIBE SELECT * FROM h5_read('test/data/simple.h5', '/integers', '/matrix')) ORDER BY column_name;
----
INTEGER
INTEGER[4]

# =============================================================================
# h5_rse() Tests - Run-Start Encoding Support
# =============================================================================

# Test h5_rse() scalar function - creates struct
query I
SELECT h5_rse('/experiment1/state_run_starts', '/experiment1/state_values')::VARCHAR;
----
{'encoding': rse, 'run_starts': /experiment1/state_run_starts, 'values': /experiment1/state_values}

# =============================================================================
# RSE Expansion Tests - Basic Functionality
# =============================================================================

# Test basic RSE expansion with int32 values (experiment1: 10 rows, 3 runs)
query II
SELECT * FROM h5_read(
    'test/data/run_encoded.h5',
    '/experiment1/timestamp',
    h5_rse('/experiment1/state_run_starts', '/experiment1/state_values')
);
----
0	100
1	100
2	100
3	200
4	200
5	200
6	200
7	300
8	300
9	300

# Test RSE expansion count
query I
SELECT COUNT(*) FROM h5_read(
    'test/data/run_encoded.h5',
    '/experiment1/timestamp',
    h5_rse('/experiment1/state_run_starts', '/experiment1/state_values')
);
----
10

# Test RSE values are correct
query III
SELECT COUNT(*) FILTER (WHERE state_values = 100),
       COUNT(*) FILTER (WHERE state_values = 200),
       COUNT(*) FILTER (WHERE state_values = 300)
FROM h5_read(
    'test/data/run_encoded.h5',
    '/experiment1/timestamp',
    h5_rse('/experiment1/state_run_starts', '/experiment1/state_values')
);
----
3	4	3

# =============================================================================
# RSE High Compression Tests
# =============================================================================

# Test high compression ratio (experiment2: 1000 rows, 4 runs)
query I
SELECT COUNT(*) FROM h5_read(
    'test/data/run_encoded.h5',
    '/experiment2/measurement',
    h5_rse('/experiment2/status_run_starts', '/experiment2/status_values')
);
----
1000

# Test aggregation on RSE data
query II
SELECT status_values, COUNT(*) as cnt
FROM h5_read(
    'test/data/run_encoded.h5',
    '/experiment2/measurement',
    h5_rse('/experiment2/status_run_starts', '/experiment2/status_values')
)
GROUP BY status_values
ORDER BY status_values;
----
0	600
1	300
2	100

# Test RSE column in WHERE clause
query I
SELECT COUNT(*) FROM h5_read(
    'test/data/run_encoded.h5',
    '/experiment2/measurement',
    h5_rse('/experiment2/status_run_starts', '/experiment2/status_values')
)
WHERE status_values = 1;
----
300

# =============================================================================
# RSE String Value Tests
# =============================================================================

# Test RSE with string values (experiment3: 8 rows, 3 runs)
query II
SELECT * FROM h5_read(
    'test/data/run_encoded.h5',
    '/experiment3/time',
    h5_rse('/experiment3/level_run_starts', '/experiment3/level_values')
);
----
0.0	low
1.0	low
2.0	low
3.0	high
4.0	high
5.0	high
6.0	high
7.0	low

# Test string RSE aggregation
query II
SELECT level_values, COUNT(*) as cnt
FROM h5_read(
    'test/data/run_encoded.h5',
    '/experiment3/time',
    h5_rse('/experiment3/level_run_starts', '/experiment3/level_values')
)
GROUP BY level_values
ORDER BY level_values;
----
high	4
low	4

# =============================================================================
# RSE Edge Cases
# =============================================================================

# Test single run (edge_cases: all same value)
query I
SELECT COUNT(DISTINCT single_run_values) FROM h5_read(
    'test/data/run_encoded.h5',
    '/edge_cases/index',
    h5_rse('/edge_cases/single_run_starts', '/edge_cases/single_run_values')
);
----
1

# Test no compression (no_compression: every value different)
query I
SELECT COUNT(DISTINCT bad_rle_values) FROM h5_read(
    'test/data/run_encoded.h5',
    '/no_compression/seq',
    h5_rse('/no_compression/bad_rle_starts', '/no_compression/bad_rle_values')
);
----
5

# =============================================================================
# RSE Mixed Column Tests
# =============================================================================

# Test mixing multiple regular and RSE columns
query I
SELECT COUNT(*) FROM h5_read(
    'test/data/run_encoded.h5',
    '/experiment2/measurement',
    '/experiment2/sensor_id',
    h5_rse('/experiment2/status_run_starts', '/experiment2/status_values')
);
----
1000

# Test column ordering with mixed types
query I
SELECT column_name FROM (DESCRIBE SELECT * FROM h5_read(
    'test/data/run_encoded.h5',
    '/experiment1/timestamp',
    h5_rse('/experiment1/state_run_starts', '/experiment1/state_values')
)) ORDER BY column_name;
----
state_values
timestamp

# =============================================================================
# RSE Type Detection Tests
# =============================================================================

# Test RSE column type detection (int32)
query I
SELECT column_type FROM (DESCRIBE SELECT * FROM h5_read(
    'test/data/run_encoded.h5',
    '/experiment1/timestamp',
    h5_rse('/experiment1/state_run_starts', '/experiment1/state_values')
))
WHERE column_name = 'state_values';
----
INTEGER

# Test RSE column type detection (varchar)
query I
SELECT column_type FROM (DESCRIBE SELECT * FROM h5_read(
    'test/data/run_encoded.h5',
    '/experiment3/time',
    h5_rse('/experiment3/level_run_starts', '/experiment3/level_values')
))
WHERE column_name = 'level_values';
----
VARCHAR

# =============================================================================
# RSE Error Handling Tests
# =============================================================================

# Test error: no regular columns (RSE only)
statement error
SELECT * FROM h5_read(
    'test/data/run_encoded.h5',
    h5_rse('/experiment1/state_run_starts', '/experiment1/state_values')
);
----
IO Error: h5_read requires at least one regular (non-RSE) dataset to determine row count

# Test error: non-existent run_starts dataset
statement error
SELECT * FROM h5_read(
    'test/data/run_encoded.h5',
    '/experiment1/timestamp',
    h5_rse('/nonexistent_starts', '/experiment1/state_values')
);
----
IO Error: Failed to open RSE run_starts dataset: /nonexistent_starts

# Test error: non-existent values dataset
statement error
SELECT * FROM h5_read(
    'test/data/run_encoded.h5',
    '/experiment1/timestamp',
    h5_rse('/experiment1/state_run_starts', '/nonexistent_values')
);
----
IO Error: Failed to open RSE values dataset: /nonexistent_values

#===--------------------------------------------------------------------===#
# h5_attributes tests
#===--------------------------------------------------------------------===#

# Test reading scalar and array attributes from a dataset
query IITTIIIIIIRRT
SELECT * FROM h5_attributes('test/data/with_attrs.h5', '/dataset_with_attrs');
----
42	1234	[1, 2, 3, 4, 5]	[1.1, 2.2, 3.3]	123456	9876543210	255	65535	4294967295	18446744073709551615	3.14159	2.718281828	Hello HDF5!

# Test reading attributes from a group
query ITI
SELECT * FROM h5_attributes('test/data/with_attrs.h5', '/group_with_attrs');
----
999	I am a group	[10, 20, 30]

# Test verifying column names match attribute names
query I
SELECT int32_attr FROM h5_attributes('test/data/with_attrs.h5', '/dataset_with_attrs');
----
123456

# Test verifying string attribute
query T
SELECT string_attr FROM h5_attributes('test/data/with_attrs.h5', '/dataset_with_attrs');
----
Hello HDF5!

# Test verifying specific numeric attributes
query IIR
SELECT int8_attr, uint64_attr, float64_attr FROM h5_attributes('test/data/with_attrs.h5', '/dataset_with_attrs');
----
42	18446744073709551615	2.718281828

# Test error: non-existent file
statement error
SELECT * FROM h5_attributes('nonexistent.h5', '/dataset');
----
IO Error: Failed to open HDF5 file: nonexistent.h5

# Test error: non-existent object path
statement error
SELECT * FROM h5_attributes('test/data/with_attrs.h5', '/nonexistent_path');
----
IO Error: Failed to open object: /nonexistent_path

